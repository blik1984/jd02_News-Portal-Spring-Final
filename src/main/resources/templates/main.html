<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity6">

<head>
<meta charset="UTF-8" />
<title>NewsPortal – Главная</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- Bootstrap -->
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
	rel="stylesheet">
<!-- Bootstrap Icons -->
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

<style>
.news-card img {
	height: 180px;
	object-fit: cover;
}

.header-top {
	background-color: #f1f1f1;
	padding: 10px 0;
}

footer {
	background-color: #f8f9fa;
	padding: 20px 0;
	margin-top: 40px;
	text-align: center;
}
</style>
</head>

<body>
	<header class="header-top">
		<div
			class="container d-flex justify-content-between align-items-center">
			<div>
				<a href="/" class="text-dark text-decoration-none fs-4 fw-bold">NewsPortal</a>
			</div>
			<div class="d-flex align-items-center">
				<!-- Language -->
				<div class="language-switcher me-3">
					<span>Language:</span> <a href="/SwitchLanguage?lang=ru"><button
							class="btn btn-sm btn-outline-secondary">RU</button></a> <a
						href="/SwitchLanguage?lang=en"><button
							class="btn btn-sm btn-outline-secondary">EN</button></a> <a
						href="/SwitchLanguage?lang=by"><button
							class="btn btn-sm btn-outline-secondary">BY</button></a>
				</div>

				<!-- Authentication -->
				<div>
					<!-- GUEST -->
					<div th:if="${currentUserName == null}">
						<a href="/page_auth" class="btn btn-sm btn-outline-primary me-2">Войти</a>
						<a href="/page_registration"
							class="btn btn-sm btn-outline-success">Регистрация</a>
					</div>

					<!-- USER / ADMIN -->
					<div th:if="${currentUserName != null}">
						<span class="me-3"> Привет, <b th:text="${currentUserName}"></b>!
							<span th:if="${currentUser != null and currentUser.role != null}">
								<span th:if="${currentUser.role.name() == 'ADMIN'}"
								class="badge bg-danger ms-2">ADMIN</span> <span
								th:if="${currentUser.role.name() == 'USER' and currentUser.activ == true}"
								class="badge bg-primary ms-2">USER</span>
								<span
								th:if="${currentUser.role.name() == 'USER' and currentUser.activ == false}"
								class="badge bg-primary ms-2">BANNED</span>
						</span>
						</span>

						<!-- Кнопка создания новости только для ADMIN -->
						<a
							th:if="${currentUser != null and currentUser.role != null and currentUser.role.name() == 'ADMIN'}"
							href="/page_create_news" class="btn btn-primary btn-sm me-2">
							Создать новость </a>

						<!-- ADMIN PANEL -->
						<a
							th:if="${currentUser != null and currentUser.role != null and currentUser.role.name() == 'ADMIN'}"
							href="/admin_panel" class="btn btn-sm btn-outline-warning me-2">
							<i class="bi bi-speedometer2"></i> Admin Panel
						</a>


						<!-- КНОПКА ПРОФИЛЯ -->
						<a href="/page_profile"
							class="btn btn-sm btn-outline-secondary me-2"> <i
							class="bi bi-person-circle"></i> Профиль
						</a>

						<!-- LOGOUT -->
						<form th:action="@{/logout}" method="post" style="display: inline">
							<button class="btn btn-sm btn-outline-danger">Выход</button>
						</form>
					</div>

				</div>
			</div>
		</div>
	</header>

	<main class="container mt-4">
		<!-- Выбор количества новостей -->
		<div class="mb-3">
			<label class="form-label">Количество новостей на странице:</label> <select
				id="newsCountSelect" class="form-select" style="width: 150px;">
				<option th:selected="${pageSize == 3}" value="3">3</option>
				<option th:selected="${pageSize == 6}" value="6">6</option>
				<option th:selected="${pageSize == 9}" value="9">9</option>
			</select>
		</div>

		<!-- Контейнер для новостей -->
		<div class="row">
			<div th:each="news : ${newsList}" class="col-md-4 mb-4">
				<div class="card h-100">
					<div class="card-body">
						<a th:href="@{/(newsGroupId=${news.newsGroup.id})}"
							class="badge bg-primary text-decoration-none"> <i
							class="bi bi-tags"></i> <span th:text="${news.newsGroup.name}"></span>
						</a>
						<h5 class="card-title" th:text="${news.title}">Заголовок</h5>
						<p class="card-text" th:text="${news.brief}">Краткое описание
							новости</p>

						<!-- GUEST /BANNED USER -->
						<div th:if="${currentUserName == null or currentUser.activ ==  false}" class="mt-3">
							<div class="alert alert-info py-2 mb-0">
								<small><i class="bi bi-info-circle"></i> Для дальнейшего
									ознакомления с материалом необходима авторизация</small>
							</div>
						</div>

						<!-- USER и ADMIN -->
						<th:block th:if="${currentUserName != null}">
							<th:block
								th:if="${currentUser != null and currentUser.role != null and currentUser.activ == true}">
								<div class="mt-3">
									<div class="d-flex justify-content-between align-items-center">
										<!-- Кнопка "Читать далее" -->
										<a
											th:href="@{/page_news(newsId=${news.id}, newsGroupId=${newsGroupId}, page=${currentPage})}">
											Читать новость </a>
										<!-- Для ADMIN показываем статус -->
										<div th:if="${currentUser.role.name() == 'ADMIN'}"
											class="text-end">
											<span class="badge"
												th:class="${news.activ} ? 'bg-success' : 'bg-secondary'"
												th:text="${news.activ} ? 'Активна' : 'Неактивна'"></span>

											<!-- Проверка времени публикации только для активных новостей -->
											<div th:if="${news.activ}" class="mt-1">
												<div th:if="${news.publishingDateTime != null}"
													class="small">
													<div
														th:if="${#temporals.createNow().isBefore(news.publishingDateTime)}"
														class="text-warning">
														<i class="bi bi-clock"></i> Ожидает публикации до: <span
															th:text="${#temporals.format(news.publishingDateTime, 'dd.MM.yyyy HH:mm')}"></span>
													</div>
													<div
														th:unless="${#temporals.createNow().isBefore(news.publishingDateTime)}"
														class="text-success">
														<i class="bi bi-check-circle"></i> Опубликовано
													</div>
												</div>
												<div th:unless="${news.publishingDateTime != null}"
													class="text-success small">
													<i class="bi bi-check-circle"></i> Опубликовано (без
													времени)
												</div>
											</div>
										</div>
									</div>
								</div>
							</th:block>
						</th:block>
					</div>

					<!-- Футер карточки -->
					<div class="card-footer text-muted">
						<small> <th:block
								th:if="${news.publishingDateTime != null}">
								<i class="bi bi-calendar-event"></i>
								<span
									th:text="${#temporals.format(news.publishingDateTime, 'dd.MM.yyyy')}"></span>
							</th:block> <th:block th:unless="${news.publishingDateTime != null}">
								<th:block th:if="${news.createDateTime != null}">
									<i class="bi bi-calendar-plus"></i>
									<span
										th:text="${#temporals.format(news.createDateTime, 'dd.MM.yyyy')}"></span>
								</th:block>
							</th:block>  <th:block
								th:if="${news.authors != null and !news.authors.isEmpty()}">
								<span class="ms-2"> | <i class="bi bi-person"></i>
									Авторы: <span th:each="author, iterStat : ${news.authors}">
										<span th:text="${author.name}"></span> <span
										th:if="${!iterStat.last}">, </span>
								</span>
								</span>
							</th:block>

						</small>
					</div>
				</div>
			</div>

			<!-- Если новостей нет -->
			<div th:if="${#lists.isEmpty(newsList)}" class="col-12">
				<div class="alert alert-info text-center">
					<i class="bi bi-newspaper"></i> На данный момент новостей нет.
					<th:block
						th:if="${currentUserName != null and currentUser != null and currentUser.role != null and currentUser.role.name() == 'ADMIN'}">
						<a th:href="@{/page_create_news}" class="alert-link">Создайте
							первую новость</a>
					</th:block>
				</div>
			</div>
		</div>

		<!-- Пагинация -->
		<div th:if="${totalPages > 1}" class="mt-4">
			<nav>
				<ul class="pagination justify-content-center">
					<li class="page-item"
						th:classappend="${currentPage == 0} ? 'disabled' : ''"><a
						class="page-link"
						th:href="@{/(page=0, size=${pageSize}, newsGroupId=${newsGroupId})}">Первая</a>
					</li>
					<li class="page-item"
						th:classappend="${currentPage == 0} ? 'disabled' : ''"><a
						class="page-link"
						th:href="@{/(page=${currentPage - 1}, size=${pageSize}, newsGroupId=${newsGroupId})}">←</a>
					</li>
					<li th:each="pageNum : ${#numbers.sequence(0, totalPages - 1)}"
						class="page-item"
						th:classappend="${pageNum == currentPage} ? 'active' : ''"><a
						class="page-link"
						th:href="@{/(page=${pageNum}, size=${pageSize}, newsGroupId=${newsGroupId})}"
						th:text="${pageNum + 1}"></a></li>
					<li class="page-item"
						th:classappend="${currentPage == totalPages - 1} ? 'disabled' : ''">
						<a class="page-link"
						th:href="@{/(page=${currentPage + 1}, size=${pageSize}, newsGroupId=${newsGroupId})}">→</a>
					</li>
					<li class="page-item"
						th:classappend="${currentPage == totalPages - 1} ? 'disabled' : ''">
						<a class="page-link"
						th:href="@{/(page=${totalPages - 1}, size=${pageSize}, newsGroupId=${newsGroupId})}">Последняя</a>
					</li>
				</ul>
			</nav>
		</div>
	</main>

	<footer>
		<div class="container text-center">
			<p class="mb-0">
				© 2025 NewsPortal. Все права защищены. | <a href="/page_privacy">Политика
					конфиденциальности</a>
			</p>
		</div>
	</footer>

	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

	<script>
		document
				.getElementById('newsCountSelect')
				.addEventListener(
						'change',
						function() {
							const newSize = this.value;
							const urlParams = new URLSearchParams(
									window.location.search);
							const currentPage = urlParams.get('page') || 0;
							window.location.href = `/?page=${currentPage}&size=${newSize}`;
						});

		document.addEventListener('DOMContentLoaded', function() {
			const urlParams = new URLSearchParams(window.location.search);
			const sizeParam = urlParams.get('size');
			const select = document.getElementById('newsCountSelect');
			if (sizeParam)
				select.value = sizeParam;
		});
	</script>
</body>
</html>